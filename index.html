<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border-top-color: #3B82F6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        select, input, textarea {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }
        select {
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em;
        }
        #video-container { transform: scaleX(-1); }
        .tab-button.active {
            border-bottom-color: #3B82F6;
            color: #3B82F6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen py-8">

    <!-- Container Utama -->
    <div class="container mx-auto p-4 md:p-8 max-w-2xl w-full">
        <div id="main-card" class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            
            <!-- Tampilan Karyawan (Default) -->
            <div id="employee-view">
                 <header class="text-center mb-8">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-700">Absensi Karyawan</h1>
                    <p class="text-gray-500 mt-1">Politeknik Pariwisata Makassar</p>
                    <div id="clock" class="mt-4 text-lg font-semibold text-blue-600 bg-blue-50 p-3 rounded-lg border border-blue-200">Memuat waktu...</div>
                </header>
                <main class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-6">
                             <div>
                                <label for="employeeNameSelect" class="block text-sm font-medium text-gray-600 mb-2">Nama Karyawan</label>
                                <select id="employeeNameSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition bg-white">
                                    <option value="" disabled selected>-- Pilih Nama Anda --</option>
                                    <option value="MUH FIRZYAH MAULANA">MUH FIRZYAH MAULANA</option>
                                    <option value="Andriani Kartia">Andriani Kartia</option>
                                    <option value="ANI">ANI</option>
                                    <option value="Ansari Ikhwan">Ansari Ikhwan</option>
                                    <option value="HAMSAH">HAMSAH</option>
                                    <option value="MIRNAWATI">MIRNAWATI</option>
                                    <option value="BAKRI DAENG SEWANG">BAKRI DAENG SEWANG</option>
                                    <option value="JUNAEDI">JUNAEDI</option>
                                    <option value="ANDI SUDIRGA">ANDI SUDIRGA</option>
                                    <option value="DAHLAN DG REWA">DAHLAN DG REWA</option>
                                    <option value="sainuddin Dg nai">sainuddin Dg nai</option>
                                    <option value="ITA">ITA</option>
                                    <option value="Syamsuddin dg limpo">Syamsuddin dg limpo</option>
                                    <option value="SARINAH">SARINAH</option>
                                    <option value="RENALDO SAFARUDDIN ALI">RENALDO SAFARUDDIN ALI</option>
                                    <option value="jumariah dg suji">jumariah dg suji</option>
                                </select>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button id="clockInBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition shadow-md disabled:opacity-50" disabled>Jam Datang</button>
                                <button id="clockOutBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition shadow-md disabled:opacity-50" disabled>Jam Pulang</button>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-md font-semibold mb-3 text-gray-700">Status Absensi</h3>
                            <div class="space-y-1 text-xs text-gray-600">
                                <p>Status GPS: <span id="locationStatus" class="font-medium text-yellow-600">Mencari...</span></p>
                                <p>Jarak: <span id="distanceStatus" class="font-medium text-yellow-600">-</span></p>
                                <p>Status: <span id="workLocationStatus" class="font-medium text-yellow-600">Memeriksa...</span></p>
                            </div>
                            <div id="locationError" class="text-red-600 mt-2 text-sm font-medium"></div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Tampilan Supervisor (Tersembunyi) -->
            <div id="supervisor-view" class="hidden">
                <header class="mb-6 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-700">Dasbor Supervisor</h1>
                    <button id="logoutBtn" class="text-sm text-blue-600 hover:underline">Logout</button>
                </header>
                
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex -mb-px space-x-6">
                        <button data-tab="absence" class="tab-button active py-3 px-1 border-b-2">Keterangan Absen</button>
                        <button data-tab="report" class="tab-button py-3 px-1 border-b-2">Laporan Harian</button>
                        <button data-tab="expense" class="tab-button py-3 px-1 border-b-2">Input Pengeluaran</button>
                    </nav>
                </div>
                
                <main>
                    <div id="absence-tab" class="tab-content space-y-4">
                        <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border">Input keterangan untuk karyawan yang tidak hadir.</p>
                        <!-- Form Keterangan Absen -->
                    </div>

                    <div id="report-tab" class="tab-content hidden space-y-4">
                        <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border">Tulis laporan kegiatan harian di sini.</p>
                        <!-- Form Laporan Harian -->
                    </div>

                    <div id="expense-tab" class="tab-content hidden space-y-4">
                         <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border">Catat pengeluaran operasional dan unggah foto bukti.</p>
                         <!-- Form Input Pengeluaran -->
                         <div class="space-y-4">
                            <div>
                                <label for="expenseDate" class="block text-sm font-medium text-gray-600 mb-1">Tanggal</label>
                                <input type="date" id="expenseDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label for="expenseDescription" class="block text-sm font-medium text-gray-600 mb-1">Keterangan</label>
                                <input type="text" id="expenseDescription" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Contoh: Pembelian air galon">
                            </div>
                            <div>
                                <label for="expenseAmount" class="block text-sm font-medium text-gray-600 mb-1">Jumlah (Rp)</label>
                                <input type="number" id="expenseAmount" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000">
                            </div>
                            <button id="takeReceiptPhotoBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">Ambil Foto Nota</button>
                            <img id="receiptPreview" class="hidden rounded-lg mt-2 max-h-40 mx-auto">
                            <button id="submitExpenseBtn" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50" disabled>Simpan Pengeluaran</button>
                         </div>
                         
                         <hr class="my-6">

                         <!-- BAGIAN BARU: Laporan Pengeluaran Bulanan -->
                         <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700">Rekap Pengeluaran Bulan Ini</h3>
                            <button id="viewExpenseReportBtn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Lihat Laporan Bulan Ini</button>
                            <div id="expenseReportContainer" class="hidden mt-4">
                                <div class="overflow-x-auto bg-white rounded-lg border">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="p-3 text-left">Tanggal</th>
                                                <th class="p-3 text-left">Keterangan</th>
                                                <th class="p-3 text-right">Jumlah (Rp)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="expenseReportBody">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </tbody>
                                        <tfoot class="bg-gray-100 font-bold">
                                            <tr>
                                                <td colspan="2" class="p-3 text-right">Total Pengeluaran:</td>
                                                <td id="expenseReportTotal" class="p-3 text-right">Rp 0</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                         </div>
                    </div>
                </main>
            </div>
            
            <footer class="text-center mt-8">
                <a href="#" id="supervisorLoginLink" class="text-sm text-gray-500 hover:text-blue-600">Login Supervisor</a>
            </footer>
        </div>
    </div>

    <!-- Modal Kamera -->
    <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 hidden">
       <!-- Konten Modal Kamera -->
    </div>
    
    <!-- Modal Loading -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <!-- Konten Modal Loading -->
    </div>

    <script>
        // --- PENGATURAN ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyV-_XTuHXfuUcw7xhj5f82iByvpPpJwJGGPVP3uE3W1TgArhMsoEHhNHwDxBGJVHLV1A/exec";
        const SUPERVISOR_PASSWORD = "admin123";
        // ... pengaturan lainnya ...

        // --- ELEMEN-ELEMEN BARU ---
        const viewExpenseReportBtn = document.getElementById('viewExpenseReportBtn');
        const expenseReportContainer = document.getElementById('expenseReportContainer');
        const expenseReportBody = document.getElementById('expenseReportBody');
        const expenseReportTotal = document.getElementById('expenseReportTotal');

        // --- FUNGSI BARU: Mengambil dan Menampilkan Laporan Pengeluaran ---
        async function fetchAndDisplayExpenses() {
            showOverlay('Mengambil laporan...');
            const payload = { action: 'get_monthly_expenses' };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                });
                const result = await response.json();
                
                if (result.status === "success") {
                    expenseReportBody.innerHTML = ''; // Kosongkan tabel
                    if (result.data.expenses.length === 0) {
                        expenseReportBody.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-gray-500">Belum ada data pengeluaran bulan ini.</td></tr>';
                    } else {
                        result.data.expenses.forEach(exp => {
                            const row = `<tr>
                                <td class="p-3">${exp.date}</td>
                                <td class="p-3">${exp.description}</td>
                                <td class="p-3 text-right">${exp.amount.toLocaleString('id-ID')}</td>
                            </tr>`;
                            expenseReportBody.innerHTML += row;
                        });
                    }
                    expenseReportTotal.textContent = `Rp ${result.data.total.toLocaleString('id-ID')}`;
                    expenseReportContainer.classList.remove('hidden');
                    hideOverlay();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showOverlayMessage(`Error: ${error.message}`, true);
                setTimeout(hideOverlay, 2500);
            }
        }

        // --- EVENT LISTENER BARU ---
        viewExpenseReportBtn.addEventListener('click', fetchAndDisplayExpenses);

        // ... sisa kode JavaScript Anda yang sudah ada ...
    </script>
</body>
</html>

